# 샤딩 관리

## 1. 현재 상태 확인

 - `요약 정보 얻기`
    - sh.status()는 샤드, 데이터베이스, 샤딩된 컬렉션의 개요를 제공한다.
```javascript
sh.status()
sh.status(true) // 상세 정보 출력
```

 - `구성 정보 확인하기`
    - 클러스터에 대한 모든 구성 정보는 구성 서버의 config 데이터베이스 내 컬렉션에 보관된다.
```javascript
// shards 컬렉션은 클러스터 내 모든 샤드를 추적한다.
db.shards.find()

// databases 컬렉션은 클러스터가 알고 있는 모든 샤딩 및 비샤딩 데이터베이스를 추적한다.
db.databases.find()

// collections 컬렉션은 모든 샤딩된 컬렉션을 추적한다.
db.collections.find().pretty()

// chunks 컬렉션은 모든 컬렉션 내 모든 청크의 기록을 보관한다.
db.chunks.find().skip(1).limit(1).pretty()

// changelog 컬렉션은 발생한 분할과 마이그레이션을 모두 기록하므로 클러스터가 무엇을 하고 있는지 추적한다.
db.changelog.find({what: "split"}).pretty()
```

## 2. 네트워크 연결 추적

 - `연결 통계 확인`
    - connPoolStats 명령은 현재 데이터베이스 인스턴스에서 샤드 클러스터나 복제 셋의 다른 멤버로 나가는 열린 연결에 대한 정보를 반환한다.
    - connPoolStats는 실행 중인 작업과 간섭을 피하려고 락을 사용하지 않는다. 때문에, 정보 수집시 개수가 약간 바뀌어, 호스트와 풀 연결 개수 간에 약간의 차이가 있을 수 있다.
```javascript
db.adminCommand({"connPoolStats": 1})
```

## 3. 서버 관리

클러스터가 커지면 용량을 추가하거나 구성을 바꿀 필요가 있다.

 - `서버 추가`
    - 언제든지 새로운 mongos 프로세스를 추가할 수 있다.
    - mongos의 --configdb 옵션이 올바른 구성 서버 셋을 명시하는지 확인한다.
    - 새로운 샤드를 추가하려면 addShard 명령을 사용한다.
 - `샤드의 서버 변경`
    - 샤드의 멤버 구성을 변경하려면 샤드의 프라이머리에 직접 연결해 복제 셋을 재구성한다.
    - 클러스터 구성은 변경 사항을 가져와서 config.shards를 자동으로 수정한다.
 - `샤드 제거`
    - 일반적으로 샤드는 클러스터에서 제거되면 안 된다. 샤드를 추가하거나 제거하면 시스템에 필요 이상으로 무리를 준다.
    - 필요한 경우 샤드를 제거할 수 있다. 밸런서는 배출이라는 프로세스에서, 제거하려는 샤드의 모든 데이터를 다른 샤드로 이동하는 임무가 있다.
    - 청크가 많거나 이동할 청크가 크면 배출이 오래 걸린다.
```javascript
db.adminCommnad({"removeShard": "shard03"})
```
