# CDC(Change Data Capture)

CDC(ë³€ê²½ ë°ì´í„° ìº¡ì²˜, Change Data Capture)ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë³€ê²½ëœ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì§€í•˜ê³  ì´ë¥¼ ì™¸ë¶€ ì‹œìŠ¤í…œìœ¼ë¡œ ì „ë‹¬í•˜ëŠ” ê¸°ìˆ ì…ë‹ˆë‹¤. ê¸°ì¡´ì—ëŠ” ë°°ì¹˜ ë°©ì‹ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì¡°íšŒí•˜ì—¬ ë³€ê²½ ì‚¬í•­ì„ ë™ê¸°í™”í–ˆì§€ë§Œ, CDCëŠ” íŠ¸ëœì­ì…˜ ë¡œê·¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì´ë²¤íŠ¸ ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„° ë³€ê²½ì„ ê°ì§€í•˜ì—¬ ë¹ ë¥´ê²Œ ë°˜ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

 - __ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”__: ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½ ì‚¬í•­ì„ ë¹ ë¥´ê²Œ ë°˜ì˜í•˜ì—¬ ì‹¤ì‹œê°„ ë¶„ì„, ë¡œê·¸ ì²˜ë¦¬ ë“±ì— í™œìš© ê°€ëŠ¥
 - __ë°ì´í„° ì¼ê´€ì„± ìœ ì§€__: ìˆ˜ë™ ë°°ì¹˜ ë°©ì‹ë³´ë‹¤ ìµœì‹  ë°ì´í„°ë¥¼ ìœ ì§€í•  ìˆ˜ ìˆìŒ
 - __ë¶€í•˜ ê°ì†Œ__: CDCëŠ” ë°ì´í„°ë² ì´ìŠ¤ íŠ¸ëœì­ì…˜ ë¡œê·¸ë¥¼ í™œìš©í•˜ì—¬ íš¨ìœ¨ì ìœ¼ë¡œ ë™ì‘
 - __ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ ì§€ì›__: Kafkaì™€ ê°™ì€ ë©”ì‹œì§€ íì™€ ê²°í•©í•˜ë©´ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œ ë°ì´í„° ë³€ê²½ ì‚¬í•­ì„ ë¹ ë¥´ê²Œ ê³µìœ  ê°€ëŠ¥


## 1. CDC ê°œìš” ë° ì‹¤ë¬´ ì‚¬ë¡€

AíŒ€ì—ì„œ ë°ì´í„° ì›ì²œì„ ê´€ë¦¬í•˜ëŠ”ë°, BíŒ€ì—ì„œ ì´ ë°ì´í„°ë¥¼ ê³„ì† ì‹±í¬ ë°›ì•„ì•¼ í•œë‹¤ë©´?

 - AíŒ€ì˜ DBì— BíŒ€ì´ ì•„ì˜ˆ ì§ì ‘ ë¶™ì–´ì„œ ì„œë¹„ìŠ¤ì— ì‚¬ìš©í•˜ëŠ” ë°©ë²•
 - AíŒ€ì˜ DBì— BíŒ€ì´ ì£¼ê¸°ì ìœ¼ë¡œ ì§ì ‘ ë¶™ì–´ì„œ ì‹±í¬í•´ì˜¨ ë’¤, BíŒ€ ìì²´ì ìœ¼ë¡œ êµ¬ì¶•í•œ ë³µì‚¬ë³¸ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•
 - AíŒ€ì´ Kafkaë¥¼ í†µí•´ ë©”ì‹œì§€ í˜•íƒœë¡œ ë³€ê²½ì‚¬í•­ì„ Produce í•´ì£¼ë©´, BíŒ€ì—ì„œ Consumeí•´ì„œ ë°ì´í„°ë¥¼ ì¤€ì‹¤ì‹œê°„ ì‹±í¬í•˜ëŠ” ë°©ë²•

## 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œì˜ CDC vs ì¸í”„ë¼ ë ˆë²¨ì—ì„œì˜ CDC

 - `ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œì˜ CDC`
    - DBì— CUDì™€ Message Produce ì§„í–‰
    - 2ê°€ì§€ì— Dual Write í•˜ê²Œ ëœë‹¤. íœ´ë¨¼ ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤. (ë°ì´í„° ëˆ„ë½)
    - 2ê°œì˜ ì •í•©ì„± ë¬¸ì œ

<div align="center">
    <img src="./images/05.PNG">
</div>
<br/>

 - `ì¸í”„ë¼ ë ˆë²¨ì—ì„œì˜ CDC`
    - ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” DBì—ë§Œ CUD
    - ë³€ê²½ ì‚¬í•­ì— ë”°ë¼ Message Produce ì§„í–‰

<div align="center">
    <img src="./images/06.PNG">
</div>
<br/>

## 3. ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ CDC ì§ì ‘ êµ¬í˜„í•˜ê¸°

### 3-1. Dual Write(@Transactional + ë©”ì‹œì§€ ë°œí–‰)

DB Write ìˆ˜í–‰ í›„ ë©”ì‹œì§€ë¥¼ ë°œí–‰í•œë‹¤. ì´ë•Œ, ë©”ì‹œì§€ë¥¼ ë°œí–‰í•˜ê³  ì´í›„ ë¡œì§ì´ ìˆì„ ë•Œ ì´í›„ ë¡œì§ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ DBëŠ” ë¡¤ë°±ë˜ëŠ”ë° ë©”ì‹œì§€ê°€ ë°œí–‰ë˜ëŠ” ìƒí™©ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤. (DBì— ë°˜ì˜ ì•ˆë¼ê³ , ì¹´í”„ì¹´ í”„ë¡œë“€ì‹± ì„±ê³µ)

 - `MyService`
    - save(Create, Update), delete(Delete)ì‹œ ë©”ì‹œì§€ ë°œí–‰
    - DBì— ë°ì´í„° ì €ì¥ í›„ ë§ˆì§€ë§‰ ë°ì´í„° ìƒíƒœì— ëŒ€í•´ì„œ ë©”ì‹œì§€ ë°œí–‰
```java
@RequiredArgsConstructor
@Service
public class MyServiceImpl implements MyService {

    private final MyJpaRepository myJpaRepository;
    private final MyCdcProducer myCdcProducer;

    @Override
    public List<MyModel> findAll() {
        List<MyEntity> entities = myJpaRepository.findAll();
        return entities.stream().map(MyModelConverter::toModel).toList();
    }

    @Override
    public MyModel findById(Integer id) {
        Optional<MyEntity> entity = myJpaRepository.findById(id);
        return entity.map(MyModelConverter::toModel).orElse(null);
    }

    @Override
    @Transactional
    public MyModel save(MyModel model) {
        OperationType operationType = model.getId() == null ? OperationType.CREATE : OperationType.UPDATE;
        MyEntity entity = myJpaRepository.save(MyModelConverter.toEntity(model));
        MyModel resultModel = MyModelConverter.toModel(entity);
        try {
            myCdcProducer.sendMessage(
                MyModelConverter.toMessage(
                    resultModel.getId(),
                    resultModel,
                    operationType
                )
            );
        } catch (JsonProcessingException e) {
            throw new RuntimeException("Error processing JSON for sendMessage", e);
        }
        return resultModel;
    }

    @Override
    @Transactional
    public void delete(Integer id) {
        myJpaRepository.deleteById(id);
        try {
            myCdcProducer.sendMessage(
                MyModelConverter.toMessage(id, null, OperationType.DELETE)
            );
        } catch (JsonProcessingException e) {
            throw new RuntimeException("Error processing JSON for sendMessage", e);
        }
    }
}
```

### 3-2. ApplicationEvent + TransactionalEventListener

@TransactionalEventListenerëŠ” íŠ¸ëœì­ì…˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¡œ, íŠ¹ì • íŠ¸ëœì­ì…˜ì˜ ìƒíƒœì— ë”°ë¼ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤. ì¼ë°˜ì ì¸ @EventListenerì™€ ë‹¬ë¦¬ íŠ¸ëœì­ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì»¤ë°‹ëœ í›„ì— ì‹¤í–‰ë˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Springì˜ ì´ë²¤íŠ¸ ì‹œìŠ¤í…œì—ì„œ ì´ë²¤íŠ¸ë¥¼ ë°œìƒì‹œí‚¤ë©´ @EventListenerë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ ë°©ì‹ì€ íŠ¸ëœì­ì…˜ê³¼ ë³„ê°œë¡œ ë™ì‘í•˜ê¸° ë•Œë¬¸ì—, ë°ì´í„°ê°€ ì»¤ë°‹ë˜ê¸° ì „ì— ì‹¤í–‰ë  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

@TransactionalEventListenerë¥¼ ì‚¬ìš©í•˜ë©´ íŠ¸ëœì­ì…˜ì˜ ìƒíƒœ(ì»¤ë°‹ ë˜ëŠ” ë¡¤ë°±)ì— ë”°ë¼ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í• ì§€ ê²°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ë°ì´í„°ê°€ ì»¤ë°‹ëœ í›„ ì•ˆì „í•˜ê²Œ ì‹¤í–‰í•´ì•¼ í•˜ëŠ” ë¡œì§(ì˜ˆ: ì´ë©”ì¼ ì „ì†¡, ìºì‹œ ì—…ë°ì´íŠ¸, ì™¸ë¶€ API í˜¸ì¶œ ë“±)ì— ìœ ìš©í•©ë‹ˆë‹¤.

DB Write ìˆ˜í–‰ í›„ ì»¤ë°‹ ë¦¬ìŠ¤ë„ˆì— ì˜í•´ì„œ ë©”ì‹œì§€ë¥¼ ë°œí–‰í•œë‹¤. ì´ë•Œ, ë©”ì‹œì§€ ë°œí–‰ì‹œ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ DBì—ëŠ” ì €ì¥ë˜ëŠ”ë° ë©”ì‹œì§€ê°€ ë°œí–‰ë˜ì§€ ì•ŠëŠ” ìƒí™©ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤. (DBì—ëŠ” ë°˜ì˜ëì§€ë§Œ, ì¹´í”„ì¹´ì— í”„ë¡œë“€ì‹± ì‹¤íŒ¨)

 - `MyCdcApplicationEvent`
```java
@Getter
public class MyCdcApplicationEvent extends ApplicationEvent {

    private final Integer id;
    private final MyModel myModel;
    private final OperationType operationType;

    public MyCdcApplicationEvent(Object source, Integer id, MyModel myModel, OperationType operationType) {
        super(source);
        this.id = id;
        this.myModel = myModel;
        this.operationType = operationType;
    }
}
```

 - `MyServiceImpl`
    - DB CREATE/UPDATE/DELETE í›„ì— ApplicationEvent ë°œí–‰
```java
@RequiredArgsConstructor
@Service
public class MyServiceImpl implements MyService {

    private final MyJpaRepository myJpaRepository;
    private final ApplicationEventPublisher applicationEventPublisher;

    @Override
    @Transactional
    public MyModel save(MyModel model) {
        OperationType operationType = model.getId() == null ? OperationType.CREATE : OperationType.UPDATE;
        MyEntity entity = myJpaRepository.save(MyModelConverter.toEntity(model));
        MyModel resultModel = MyModelConverter.toModel(entity);
        applicationEventPublisher.publishEvent(
            new MyCdcApplicationEvent(
                this,
                resultModel.getId(),
                resultModel,
                operationType
            )
        );
        return resultModel;
    }

    @Override
    @Transactional
    public void delete(Integer id) {
        myJpaRepository.deleteById(id);
        applicationEventPublisher.publishEvent(
            new MyCdcApplicationEvent(
                this,
                id,
                null,
                OperationType.DELETE
            )
        );
    }
}
```

 - `MyCdcApplicationEventListener`
    - íŠ¸ëœì­ì…˜ ì´ë²¤íŠ¸ í›„ì— ì½œë°±
    - AFTER_COMMIT: (ê¸°ë³¸ê°’) íŠ¸ëœì­ì…˜ì´ ì„±ê³µì ìœ¼ë¡œ ì»¤ë°‹ëœ í›„ ì‹¤í–‰
    - AFTER_ROLLBACK: íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ëœ í›„ ì‹¤í–‰
    - AFTER_COMPLETION: íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ê±°ë‚˜ ë¡¤ë°±ëœ í›„ ì‹¤í–‰
    - BEFORE_COMMIT: íŠ¸ëœì­ì…˜ì´ ì»¤ë°‹ë˜ê¸° ì§ì „ ì‹¤í–‰
```java
// DBì— ì €ì¥ì´ ì˜ ëœ ì´í›„ì— ë©”ì‹œì§€ë¥¼ ë°œí–‰í•œë‹¤.
@RequiredArgsConstructor
@Component
public class MyCdcApplicationEventListener {

    private final MyCdcProducer myCdcProducer;

    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    @Async
    public void transactionalEventListenerAfterCommit(MyCdcApplicationEvent event) throws JsonProcessingException {
        myCdcProducer.sendMessage(
            MyModelConverter.toMessage(event.getId(), event.getMyModel(), event.getOperationType())
        );
    }
}
```

### 3-3. EntityListener ì´ìš©

Springê³¼ JPAë¥¼ ì‚¬ìš©í•  ë•Œ, ì—”í‹°í‹°(Entity)ì˜ ë¼ì´í”„ì‚¬ì´í´ ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•˜ì—¬ íŠ¹ì • ë¡œì§ì„ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ê¸°ëŠ¥ì´ EntityListenerì…ë‹ˆë‹¤.

EntityListenerëŠ” JPA ì—”í‹°í‹°ì— ëŒ€í•œ ìƒì„±, ìˆ˜ì •, ì‚­ì œ ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•˜ì—¬ ì½œë°± ë©”ì„œë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì¦‰, ë°ì´í„°ë² ì´ìŠ¤ì— ì—”í‹°í‹°ê°€ ì €ì¥ë˜ê±°ë‚˜ ì‚­ì œë  ë•Œ íŠ¹ì • ë¡œì§ì„ ì‹¤í–‰í•´ì•¼ í•  ê²½ìš° ìœ ìš©í•©ë‹ˆë‹¤.

__@PrePersist, @PreUpdate, @PreRemove ë“±ì„ í™œìš©í•˜ì—¬ ë°ì´í„° ë³€ê²½ ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•˜ê³  ì™¸ë¶€ ì‹œìŠ¤í…œìœ¼ë¡œ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.__

 - `EntityListener ê¸°ë°˜ CDCì˜ í™œìš© ì‚¬ë¡€`
    - ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë°: ë°ì´í„° ë³€ê²½ ì‚¬í•­ì„ Kafkaë¡œ ì „ì†¡í•˜ì—¬ ë¹„ë™ê¸° ì²˜ë¦¬
    - ê°ì‚¬ ë¡œê·¸(Audit Logging): ëª¨ë“  ë°ì´í„° ë³€ê²½ ì‚¬í•­ì„ ë¡œê¹…í•˜ì—¬ ì¶”ì  ê°€ëŠ¥
    - ElasticSearch ë™ê¸°í™”: DB ë³€ê²½ ì‚¬í•­ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ElasticSearchì— ë°˜ì˜
    - ë°ì´í„° ë°±ì—… ì‹œìŠ¤í…œ: ì‚­ì œëœ ë°ì´í„°ë¥¼ ë¡œê·¸ì— ê¸°ë¡í•˜ì—¬ ë³µêµ¬ ê°€ëŠ¥
    - ìºì‹œ ë¬´íš¨í™”(Cache Invalidation): ë°ì´í„° ë³€ê²½ ì‹œ Redis ë“±ì˜ ìºì‹œë¥¼ ì—…ë°ì´íŠ¸

 - `MyService`
```java
@RequiredArgsConstructor
@Service
public class MyServiceImpl implements MyService {

    private final MyJpaRepository myJpaRepository;

    @Override
    public MyModel save(MyModel model) {
        MyEntity entity = myJpaRepository.save(MyModelConverter.toEntity(model));
        return MyModelConverter.toModel(entity);
    }

    @Override
    public void delete(Integer id) {
        myJpaRepository.deleteById(id);
    }
}
```

 - `MyEntityListener`
    - @PrePersist: ì—”í‹°í‹°ê°€ ì €ì¥ë˜ê¸° ì „ ì‹¤í–‰
    - @PostPersist: ì—”í‹°í‹°ê°€ ì €ì¥ëœ í›„ ì‹¤í–‰
    - @PreUpdate: ì—”í‹°í‹°ê°€ ìˆ˜ì •ë˜ê¸° ì „ ì‹¤í–‰
    - @PostUpdate: ì—”í‹°í‹°ê°€ ìˆ˜ì •ëœ í›„ ì‹¤í–‰
    - @PreRemove: ì—”í‹°í‹°ê°€ ì‚­ì œë˜ê¸° ì „ ì‹¤í–‰
    - @PostRemove: ì—”í‹°í‹°ê°€ ì‚­ì œëœ í›„ ì‹¤í–‰
    - @PostLoad: ì—”í‹°í‹°ê°€ ì¡°íšŒëœ ì§í›„ ì‹¤í–‰
```java
@Component
public class MyEntityListener {

    @Lazy
    @Autowired
    private MyCdcProducer myCdcProducer;

    // ì—”í‹°í‹°ê°€ ì €ì¥ëœ í›„ ì‹¤í–‰
    @PostPersist
    public void handleCreate(MyEntity myEntity) {
        System.out.println("handleCreate");
        MyModel myModel = MyModelConverter.toModel(myEntity);
        try {
            myCdcProducer.sendMessage(
                MyModelConverter.toMessage(
                    myModel.getId(),
                    myModel,
                    OperationType.CREATE
                )
            );
        } catch (JsonProcessingException e) {
            throw new RuntimeException(e);
        }
    }

    // ì—”í‹°í‹°ê°€ ìˆ˜ì •ëœ í›„ ì‹¤í–‰
    @PostUpdate
    public void handleUpdate(MyEntity myEntity) {
        System.out.println("handleUpdate");
        MyModel myModel = MyModelConverter.toModel(myEntity);
        try {
            myCdcProducer.sendMessage(
                MyModelConverter.toMessage(
                    myModel.getId(),
                    myModel,
                    OperationType.UPDATE
                )
            );
        } catch (JsonProcessingException e) {
            throw new RuntimeException(e);
        }
    }

    // ì—”í‹°í‹°ê°€ ì‚­ì œëœ í›„ ì‹¤í–‰
    @PostRemove
    public void handleDelete(MyEntity myEntity) {
        System.out.println("handleDelete");
        MyModel myModel = MyModelConverter.toModel(myEntity);
        try {
            myCdcProducer.sendMessage(
                MyModelConverter.toMessage(
                    myModel.getId(),
                    null,
                    OperationType.DELETE
                )
            );
        } catch (JsonProcessingException e) {
            throw new RuntimeException(e);
        }
    }
}
```

### 3-4. ë©”ì‹œì§€ ë°œí–‰ì„ ë³„ë„ í…Œì´ë¸”ì— ì €ì¥í•˜ê³  ë¹„ë™ê¸° ì „ì†¡

CDC ì´ë²¤íŠ¸ë¥¼ ë³„ë„ì˜ í…Œì´ë¸”(event_outbox)ì— ì €ì¥í•œ í›„, ë°°ì¹˜ í”„ë¡œì„¸ìŠ¤ ë˜ëŠ” ì´ë²¤íŠ¸ íë¥¼ ì´ìš©í•˜ì—¬ ë¹„ë™ê¸° ì „ì†¡í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

ì´ íŒ¨í„´ì„ Outbox íŒ¨í„´ì´ë¼ê³  í•©ë‹ˆë‹¤.

 - `CDCEvent`
    - CDC ì´ë²¤íŠ¸ ì €ì¥ì„ ìœ„í•œ Outbox í…Œì´ë¸”
```java
@Entity
public class CDCEvent {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String eventType;
    private String payload;
    private LocalDateTime createdAt = LocalDateTime.now();

    public CDCEvent(String eventType, String payload) {
        this.eventType = eventType;
        this.payload = payload;
    }
}
```

 - `OrderService`
    - íŠ¸ëœì­ì…˜ë‚´ì—ì„œ ë„ë©”ì¸ í…Œì´ë¸”ê³¼ CDCEventìš© í…Œì´ë¸”ì— CRUD ì‘ì—… ì‹¤í–‰
    - ë¹„ì¦ˆë‹ˆìŠ¤ìš© ì—”í‹°í‹° ì €ì¥ê³¼ CDCEventìš© ì—”í‹°í‹° ì €ì¥ì— ëŒ€í•œ ì¼ê´€ì„±ì´ ë³´ì¥ëœë‹¤.
```java
@Service
public class OrderService {
    private final OrderRepository orderRepository;
    private final CDCEventRepository cdcEventRepository;

    public OrderService(OrderRepository orderRepository, CDCEventRepository cdcEventRepository) {
        this.orderRepository = orderRepository;
        this.cdcEventRepository = cdcEventRepository;
    }

    @Transactional
    public void createOrder(Order order) {
        orderRepository.save(order);

        // CDC ì´ë²¤íŠ¸ë¥¼ Outbox í…Œì´ë¸”ì— ì €ì¥
        String eventPayload = "{ \"orderId\": " + order.getId() + " }";
        cdcEventRepository.save(new CDCEvent("ORDER_CREATED", eventPayload));
    }
}
```

 - `CDCEventPublisher`
    - ë°°ì¹˜ í”„ë¡œì„¸ìŠ¤ë¡œ Outbox í…Œì´ë¸”ì˜ CDC ì´ë²¤íŠ¸ ì „ì†¡
    - DB íŠ¸ëœì­ì…˜ê³¼ í•¨ê»˜ CDC ì´ë²¤íŠ¸ê°€ ì•ˆì „í•˜ê²Œ ì €ì¥ë¨.
    - ë©”ì‹œì§€ ì „ì†¡ì´ ì‹¤íŒ¨í•´ë„ ì¬ì‹œë„ ê°€ëŠ¥(Outbox í…Œì´ë¸”ì— ë°ì´í„°ê°€ ë‚¨ì•„ ìˆìŒ).
    - íŠ¸ëœì­ì…˜ ë¡¤ë°± ì‹œ ì´ë²¤íŠ¸ë„ ë¡¤ë°±ë¨ â†’ ë°ì´í„° ì •í•©ì„± ìœ ì§€.
```java
@Service
public class CDCEventPublisher {
    private final CDCEventRepository cdcEventRepository;

    public CDCEventPublisher(CDCEventRepository cdcEventRepository) {
        this.cdcEventRepository = cdcEventRepository;
    }

    @Scheduled(fixedRate = 5000) // 5ì´ˆë§ˆë‹¤ ì‹¤í–‰
    public void publishEvents() {
        List<CDCEvent> events = cdcEventRepository.findAll();

        for (CDCEvent event : events) {
            try {
                // Kafka ë˜ëŠ” RabbitMQ ì „ì†¡
                System.out.println("ğŸ“¡ CDC ë©”ì‹œì§€ ë°œí–‰: " + event.getPayload());
                // ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ë©´ í•´ë‹¹ ì´ë²¤íŠ¸ ì‚­ì œ
                cdcEventRepository.delete(event);
            } catch (Exception e) {
                System.out.println("âš ï¸ CDC ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: " + e.getMessage());
                // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§ í•„ìš”
            }
        }
    }
}
```

### 3-5. Spring Retryë¥¼ ì´ìš©í•œ ì¬ì‹œë„ ë¡œì§ ì¶”ê°€

ë©”ì‹œì§€ ë°œí–‰ì´ ì‹¤íŒ¨í•˜ë©´ Spring Retryë¥¼ í™œìš©í•˜ì—¬ ìë™ìœ¼ë¡œ ì¬ì‹œë„í•˜ë„ë¡ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

 - `CDCEventListener`
    - ë©”ì‹œì§€ ë°œí–‰ì´ ì‹¤íŒ¨í•˜ë©´ ìë™ìœ¼ë¡œ ì¬ì‹œë„ë¨.
    - ì¬ì‹œë„ íšŸìˆ˜ ë° ë°±ì˜¤í”„(ëŒ€ê¸° ì‹œê°„) ì„¤ì • ê°€ëŠ¥.
    - ì„œë²„ ì¥ì•  ì‹œ ì¬ì‹œë„ê°€ ì¤‘ë‹¨ë  ìˆ˜ ìˆìŒ(ë°°ì¹˜ ë°©ì‹ë³´ë‹¤ ì‹ ë¢°ì„±ì´ ë‚®ìŒ).
```java
@Service
public class CDCEventListener {

    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    @Retryable(value = Exception.class, maxAttempts = 3, backoff = @Backoff(delay = 5000))
    public void sendOrderCreatedEvent(OrderCreatedEvent event) {
        System.out.println("ğŸ“¡ CDC ë©”ì‹œì§€ ë°œí–‰ ì‹œë„: " + event.getOrder().getId());

        // ë©”ì‹œì§€ ë°œí–‰ (Kafka, RabbitMQ)
        if (Math.random() > 0.7) { // í…ŒìŠ¤íŠ¸ìš© ëœë¤ ì‹¤íŒ¨ ì²˜ë¦¬
            throw new RuntimeException("ğŸš¨ ë©”ì‹œì§€ ë°œí–‰ ì‹¤íŒ¨!");
        }

        System.out.println("âœ… CDC ë©”ì‹œì§€ ë°œí–‰ ì„±ê³µ: " + event.getOrder().getId());
    }
}
```

## 4. Message Key ëª…ì‹œë¥¼ í†µí•œ ìˆœì„œ ë³´ì¥

 - `MyCdcProducer`
    - CDC(Change Data Capture)ëŠ” ë°ì´í„°ë§ˆë‹¤ì˜ ë³€ê²½ ì‚¬í•­ ì¶”ì ì´ í•„ìš”í•˜ë‹¤.
    - ì¦‰, í•˜ë‚˜ì˜ ë°ì´í„° ë‚´ì—ì„œ ë³€ê²½ì‚¬í•­ ìˆœì„œê°€ ì¤‘ìš”í•˜ë‹¤.
    - ì´ ë°ì´í„°ì˜ ìˆœì„œë¥¼ ë³´ì¥í•˜ê¸° ìœ„í•´ì„œ ë©”ì‹œì§€ í‚¤ë¥¼ Primary Keyë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
    - ë©”ì‹œì§€ í‚¤ì˜ ê¸°ì¤€ì€ í•´ê²°í•˜ë ¤ëŠ” ë¬¸ì œë§ˆë‹¤ ë‹¤ë¥´ë‹¤. ë‚˜ì‡ëŒ€ë³„ë¡œ ì„ ì°©ìˆœ ìˆœì„œê°€ ì¤‘ìš”í•˜ë‹¤ë©´ ë‚˜ì´ë¥¼ í‚¤ë¡œ ì¡ì„ ìˆ˜ ìˆë‹¤.
```java
@RequiredArgsConstructor
@Component
public class MyCdcProducer {

    CustomObjectMapper objectMapper = new CustomObjectMapper();

    private final KafkaTemplate<String, String> kafkaTemplate;

    public void sendMessage(MyCdcMessage message) throws JsonProcessingException {
        kafkaTemplate.send(
            Topic.MY_CDC_TOPIC,
            String.valueOf(message.getId()),
            objectMapper.writeValueAsString(message)
        );
    }
}
```

 - `MyCdcConsumer`
```java
@Component
public class MyCdcConsumer {

    private final CustomObjectMapper objectMapper = new CustomObjectMapper();

    @KafkaListener(
        topics = { MY_CDC_TOPIC },
        groupId = "cdc-consumer-group",
        concurrency = "3"
    )
    public void listen(ConsumerRecord<String, String> message, Acknowledgment acknowledgment) throws JsonProcessingException {
        MyCdcMessage myCdcMessage = objectMapper.readValue(message.value(), MyCdcMessage.class);
        System.out.println("[Cdc Consumer] " + myCdcMessage.getOperationType() + " Message arrived! (id: " + myCdcMessage.getId() + ") - " + myCdcMessage.getPayload());
        acknowledgment.acknowledge();
    }
}
```

## 5. Application ë ˆë²¨ì—ì„œ CDCë¥¼ êµ¬í˜„í•  ê·¸ ì™¸ ë°©ë²•

### 5-1. í•œê³„ì 

 - `ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ êµ¬í˜„ì˜ í•œê³„ì `
    - DBì— í™•ì‹¤íˆ ë°˜ì˜ëœ ê²ƒë§Œ Kafkaë¡œ í”„ë¡œë“€ìŠ¤í•˜ìë‹ˆ, í”„ë¡œë“€ìŠ¤ê°€ ëˆ„ë½ë  ìˆ˜ ìˆë‹¤.
    - Kafkaë¡œ í”„ë¡œë“€ìŠ¤ë¶€í„° í•˜ìë‹ˆ, DBì— ë°˜ì˜ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ Kafkaë¡œ ë¨¼ì € ìœ í†µë˜ì–´ ë²„ë¦´ ìˆ˜ ìˆë‹¤.
 - `í•œê³„ê°€ ë°œìƒí•˜ëŠ” ê·¼ë³¸ì ì¸ ì´ìœ `
    - ë°ì´í„° íë¦„ì´ ì§ë ¬ì´ ì•„ë‹ˆë¼ ë³‘ë ¬(Dual Write)ì´ë‹¤.
    - Write ëª©ì ì§€ì¸ DBì™€ Kafkaì— ëŒ€í•œ ì‘ì—…ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ì„ ìˆ˜ ì—†ë‹¤.

### 5-1. í•´ê²° ë°©ë²•: ì§ë ¬ë¡œ ë°”ê¾¸ê¸°

ì²˜ìŒìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ DBì— ì €ì¥í•œë‹¤.

ì´í›„, ë‹¤ë¥¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í•´ë‹¹ DBì— ì£¼ê¸°ì ìœ¼ë¡œ ì ‘ê·¼í•˜ëŠ” ë¡œì§ì„ ë§Œë“¤ê³ , ë§ˆì§€ë§‰ ì ‘ê·¼ ì‹œê°„ ì´í›„ì— ë ˆì½”ë“œë¥¼ ê°€ì ¸ì™€ì„œ ì¹´í”„ì¹´ë¡œ í”„ë¡œë“€ì‹±í•œë‹¤.

<div align="center">
    <img src="./images/07.PNG">
</div>
<br/>

### 5-2. í•´ê²° ë°©ë²•: ì•„ì›ƒë°•ìŠ¤ íŒ¨í„´

DBì™€ Kafkaë¥¼ íŠ¸ëœì­ì…˜ í•˜ë‚˜ë¡œ ë¬¶ì„ ìˆ˜ ì—†ë‹¤.

ì´ê²ƒì„ ë³´ì™„í•˜ê¸° ìœ„í•´ ë³´ìƒ íŠ¸ëœì­ì…˜(SAGA)ì´ ìˆì§€ë§Œ, ìš´ì˜í•˜ê¸°ì— ë³µì¡í•¨ì´ ìˆë‹¤.

DB ì €ì¥ì‹œ Kafkaë¡œ í”„ë¡œë“€ì‹±ì„ ë°”ë¡œ í•˜ì§€ ì•Šê³ , Outboxë¼ê³  í•˜ëŠ” ë³„ë„ì˜ í…Œì´ë¸”ì„ ë§Œë“¤ì–´ì„œ íë¡œ ëŒ€ì²´í•œë‹¤.

 - ë³„ë„ì˜ í…Œì´ë¸”ì´ í•„ìš”í•˜ë‹¤.
 - Outbox í…Œì´ë¸”ì— ë°ì´í„°ê°€ ë§ì´ ìŒ“ì¼ ìˆ˜ ìˆì–´, ì£¼ê¸°ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì •ë¦¬í•´ì£¼ì–´ì•¼ í•œë‹¤.

<div align="center">
    <img src="./images/08.PNG">
</div>
